<style type="text/css">
    .node rect {
        fill: transparent;
        stroke: #999;
        stroke-width: 1.5px;
        font-size: 5em;
    }
    .edgePath path {
        stroke: #333;
        stroke-width: 1.5px;
    }
    .task {
        margin-top: -.4em;
        /*margin: -.65em 0 0 -.55em;*/
        /*padding: .09em .38em .09em .38em;*/
        border-radius: 0;
    }
    .popover {
        max-width: none;
    }
</style>

<h3>{{task_name}}</h3>

<h4>Children</h4>
<svg id="svg_children" class="container-fluid"></svg>
<br><br>
<h4>Parents</h4>
<svg id="svg_parents" class="container-fluid"></svg>

<script type="text/javascript">
    function draw_graph(nodes, reverse) {
        let g = new dagreD3.graphlib.Graph()
            .setGraph({
                "rankdir": "LR"
            }).setDefaultEdgeLabel(function() { return {}; });

        for (var node in nodes) {
            // The width property doesn't seem to play well with css and html so
            // all of this is some hackery to get the css/html element to fit into
            // the node rectangle.
            var padding_chars = "**";
            var num_padding_chars = 20 - node.length;
            if (num_padding_chars > 4) {
                padding_chars = "*".repeat(num_padding_chars/2);
            }

            // The &nbsp is more hackery
            g.setNode(node, {
                "labelType": "html",
                "label": `<div id="${node}">${padding_chars}${node}${padding_chars}</div>&nbsp;`,
                "padding": 0,
            });

            for (var index in nodes[node]) {
                if (reverse == true) {
                    g.setEdge(nodes[node][index], node);
                }
                else {
                    g.setEdge(node, nodes[node][index]);
                }
            }
        }

        return g;
    }

    var children = JSON.parse('{{ children | tojson | safe }}');
    var parents = JSON.parse('{{ parents | tojson | safe }}');
    var c = draw_graph(children, false);
    var p = draw_graph(parents, true);

    var render = new dagreD3.render();

    var svg_c = d3.select("#svg_children");
    var svg_p = d3.select("#svg_parents");

    render(svg_c, c);
    render(svg_p, p);

    svg_c.attr("height", c.graph().height);
    svg_c.attr("viewBox", `0 0 ${c.graph().width} ${c.graph().height}`);

    svg_p.attr("height", p.graph().height);
    svg_p.attr("viewBox", `0 0 ${p.graph().width} ${p.graph().height}`);


    function load_task(parent_id, task_name) {
        selector = `#${parent_id} #${task_name}`;
        $.ajax({
            url: "/task",
            type: "POST",
            data: {
                "name": task_name
            },
            async: false,  // Necessary for this to work
            success: function(result) {
                $(selector).html(result);
            },
            error: function(result) {
                $(selector).html("ERROR");
            },
        });
    }

    // So here's some fun, now the the graph is drawn, overlay each node with
    // the same task html object we use everywhere else
    $(document).ready(function () {
        for (var node in children) {
            load_task("svg_children", node);
        }

        for (var node in parents) {
            load_task("svg_parents", node);
        }

        // Set properties of all the popovers at once
        $(function () {
            $('[data-toggle="popover"]').popover({
                html: true,
                placement: 'auto',
                trigger: 'manual',
                content: function(i) { return $(this).find('div.d-none').html(); }
            })
        });

        // Show the hidden popover on click of task
        $('.task').click(function() {
            $('[data-toggle="popover"]').popover('hide');
            $(this).popover('show');
        });
    });
</script>
